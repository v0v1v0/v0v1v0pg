<div class="container">

<table style="width: 100%;"><tr>
<td>emission_model</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Emission model</h2>

<h3>Description</h3>

<p>Estimate hot-exhaust emissions of public transport systems. This
function must be used together with <code>transport_model</code>.
</p>


<h3>Usage</h3>

<pre><code class="language-R">emission_model(
  tp_model,
  ef_model,
  fleet_data,
  pollutant,
  reference_year = 2020,
  heightfile = NULL,
  parallel = TRUE,
  ncores = NULL,
  output_path = NULL,
  continue = FALSE,
  quiet = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>tp_model</code></td>
<td>
<p>sf_linestring object or a character path the to sf_linestring objects.
The <code>tp_model</code> is the output from <code>transport_model</code>,
or the path in which the output files from the <code>transport_model</code> are saved.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ef_model</code></td>
<td>
<p>character. A string indicating the emission factor model
to be used. Options include <code>ef_usa_moves</code>, <code>ef_usa_emfac</code>,<code>ef_europe_emep</code>,
,<code>ef_brazil_cetesb</code>, and <code>ef_brazil_scaled_euro</code> (scale <code>ef_brazil_cetesb()</code> based
on <code>ef_scaled_euro()</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fleet_data</code></td>
<td>
<p>data.frame. A <code>data.frame</code> with information the fleet
characteristics. The required columns depend on the
<code>ef_model</code> selection. See @examples for input.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pollutant</code></td>
<td>
<p>character. Vector with one or more pollutants to be estimated.
Example: <code>c("CO", "CO2", "PM10", "NOx")</code>. See the documentation to check which
pollutants are available for each emission factor model (<code>ef_usa_moves</code>, <code>ef_usa_emfac</code>,
<code>ef_europe_emep</code>, or <code>ef_brazil_cetesb</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>reference_year</code></td>
<td>
<p>numeric. Year of reference considered to calculate the
emissions inventory. Defaults to <code>2020</code>. This
argument is only required when the <code>ef_model</code>
argument is <code>ef_usa_moves</code> or <code>ef_usa_emfac</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>heightfile</code></td>
<td>
<p>character or raster data. The raster file with height data,
or its filepath, used to estimate emissions considering the effect of
street slope. This argument is used only when <code>ef_brazil_scaled_euro</code> or
<code>ef_europe_emep</code> are selected. Default is <code>NULL</code>. Details are provided in
<code>slope_class_europe_emep</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>parallel</code></td>
<td>
<p>logical. Decides whether the function should run in parallel.
Defaults is <code>TRUE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ncores</code></td>
<td>
<p>integer. Number of cores to be used in parallel execution. This
argument is ignored if parallel is <code>FALSE</code>. Default (<code>NULL</code>) selects
the total number of available cores minus one.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>output_path</code></td>
<td>
<p>character. File path where the function output is exported.
If <code>NULL</code> (Default), the function returns the output to user.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>continue</code></td>
<td>
<p>logical. Argument that can be used only with output_path When TRUE,
it skips processing the shape identifiers that were already saved into
files. It is useful to continue processing a GTFS file that was stopped
for some reason. Default value is FALSE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>quiet</code></td>
<td>
<p>Logical; Display messages from the emissions or emission factor functions.
Default is 'TRUE'.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The <code>fleet_data</code> must be a <code>data.frame</code> organized according to the desired
<code>ef_model</code>. The required columns is organized as follows (see @examples for real
data usage).
</p>

<ul>
<li> <p><code>reference_year</code>: character; Base year of the emission factor model input.
Required only when  <code>ef_usa_moves</code> or <code style="white-space: pre;">⁠_efusa_emfac⁠</code> are selected.
</p>
</li>
<li> <p><code>tech</code>: character; After treatment technology. This is required only
when <code>emep_europe</code> is selected. Check <code>?ef_emep_europe</code> for details.
</p>
</li>
<li> <p><code>euro</code>: character; Euro period of vehicle, classified in
"Conventional", "I", "II", "III", "IV", "V", "VI", and "EEV". This is required only
when <code>ef_emep_europe</code> is selected. Check <code>ef_europe_emep</code> for details.
</p>
</li>
<li> <p><code>fuel</code>: character; Required when <code>ef_usa_moves</code>, <code>ef_usa_emfac</code> and
<code>ef_europe_emep</code> are selected.
</p>
</li>
<li> <p><code>fleet_composition</code>: Numeric. Scaled composition of fleet. In most
cases, the user might not know which vehicles run on each specific routes.
The composition is used to attribute a probability of a specific vehicle to
circulate in the line. The probability sums one. Required for all emission
factors selection.
Users can check the
<a href="https://ipeagit.github.io/gtfs2emis/articles/gtfs2emis_fleet_data.html">gtfs2emis fleet data vignette</a>,
for more examples.
</p>
</li>
</ul>
<p>Based on the input height data, the function returns the slope class between two consecutive
bus stop positions of a LineString Simple Feature (transport model object).
The slope is given by the ratio between the height difference and
network distance from two consecutive public transport stops.
The function classifies the slope into one of the seven categories
available on the European Environmental Agency (EEA) database, which is -0.06,
-0.04,-0.02, 0.00, 0.02, 0.04, and 0.06. The classifications is described in
</p>


<h3>Value</h3>

<p>A <code>list</code> with emissions estimates or <code>NULL</code> with output files saved
locally at <code>output_path</code>.
</p>


<h3>See Also</h3>

<p>Other Core function: 
<code>transport_model()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">
library(gtfstools)

# read GTFS
gtfs_file &lt;- system.file("extdata/bra_cur_gtfs.zip", package = "gtfs2emis")
gtfs &lt;- gtfstools::read_gtfs(gtfs_file) 

# keep a single trip_id to speed up this example
gtfs_small &lt;- gtfstools::filter_by_trip_id(gtfs, trip_id ="4451136")
  
# run transport model
tp_model &lt;- transport_model(gtfs_data = gtfs_small,
                            min_speed = 2,
                            max_speed = 80,
                            new_speed = 20,
                            spatial_resolution = 100,
                            parallel = FALSE)

# Example using Brazilian emission model and fleet
fleet_data_ef_cetesb &lt;- data.frame(veh_type = "BUS_URBAN_D",
                                   model_year = 2010:2019,
                                   fuel = "D",
                                   fleet_composition = rep(0.1,10)
                                   )
                                   
emi_cetesb &lt;- progressr::with_progress(emission_model(
                tp_model = tp_model,
                ef_model = "ef_brazil_cetesb",
                fleet_data = fleet_data_ef_cetesb,
                pollutant = c("CO","PM10","CO2","CH4","NOx")
                ))
                            
# Example using European emission model and fleet
fleet_data_ef_europe &lt;- data.frame(  veh_type = c("Ubus Midi &lt;=15 t",
                                                  "Ubus Std 15 - 18 t",
                                                  "Ubus Artic &gt;18 t")
                                   , euro = c("III","IV","V")
                                   , fuel = rep("D",3)
                                   , tech = c("-","SCR","SCR")
                                   , fleet_composition = c(0.4,0.5,0.1))
                                   
emi_emep &lt;- progressr::with_progress(emission_model(tp_model = tp_model
                          , ef_model = "ef_europe_emep"
                          , fleet_data = fleet_data_ef_europe
                          , pollutant = c("PM10","NOx")))

raster_cur &lt;- system.file("extdata/bra_cur-srtm.tif", package = "gtfs2emis")                           
emi_emep_slope &lt;- progressr::with_progress(emission_model(tp_model = tp_model
                          , ef_model = "ef_europe_emep"
                          , fleet_data = fleet_data_ef_europe
                          , heightfile = raster_cur
                          , pollutant = c("PM10","NOx")))  
                                                  
# Example using US EMFAC emission model and fleet
fleet_data_ef_moves &lt;- data.frame(  veh_type = "BUS_URBAN_D"
                                  , model_year = 2010:2019
                                  , fuel = "D"
                                  , reference_year = 2020
                                  , fleet_composition = rep(0.1,10))
                                  
fleet_data_ef_emfac &lt;- data.frame(  veh_type =  "BUS_URBAN_D"
                                  , model_year = 2010:2019
                                  , fuel = "D"
                                  , reference_year = 2020
                                  , fleet_composition = rep(0.1,10))
                                  
# Example using US MOVES emission model and fleet
emi_moves &lt;- emission_model(tp_model = tp_model
                          , ef_model = "ef_usa_moves"
                          , fleet_data = fleet_data_ef_moves
                          , pollutant = c("CO","PM10","CO2","CH4","NOx")
                          , reference_year = 2020)
                          
emi_emfac &lt;- emission_model(tp_model = tp_model
                          , ef_model = "ef_usa_emfac"
                          , fleet_data = fleet_data_ef_emfac
                          , pollutant = c("CO","PM10","CO2","CH4","NOx")
                          , reference_year = 2020)

</code></pre>


</div>