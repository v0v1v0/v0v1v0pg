<div class="container">

<table style="width: 100%;"><tr>
<td>cr_deploy_r</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Deploy an R script with an optional schedule</h2>

<h3>Description</h3>

<p>Will create a build to run an R script in Cloud Build with an optional schedule from Cloud Scheduler
</p>


<h3>Usage</h3>

<pre><code class="language-R">cr_deploy_r(
  r,
  schedule = NULL,
  source = NULL,
  run_name = NULL,
  r_image = "rocker/verse",
  pre_steps = NULL,
  post_steps = NULL,
  timeout = 600L,
  ...,
  schedule_type = c("pubsub", "http"),
  schedule_pubsub = NULL,
  email = cr_email_get(),
  region = cr_region_get(),
  projectId = cr_project_get(),
  serviceAccount = NULL,
  launch_browser = interactive()
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>r</code></td>
<td>
<p>R code to run or a file containing R code ending with .R, or the gs:// location on Cloud Storage of the R file you want to run</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>schedule</code></td>
<td>
<p>A cron schedule e.g. <code>"15 5 * * *"</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>source</code></td>
<td>
<p>A Source object specifying the location of the source files to build, usually created by cr_build_source</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>run_name</code></td>
<td>
<p>What name the R code will identify itself as.  If <code>NULL</code> one is autogenerated.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>r_image</code></td>
<td>
<p>The R docker environment executing the R code</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pre_steps</code></td>
<td>
<p>Other cr_buildstep to run before the R code executes</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>post_steps</code></td>
<td>
<p>Other cr_buildstep to run after the R code executes</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>timeout</code></td>
<td>
<p>Amount of time that this build should be allowed to run, to second</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>

<p>Arguments passed on to <code>cr_buildstep_r</code>
</p>

<dl>
<dt><code>name</code></dt>
<dd>
<p>The docker image that will run the R code, usually from rocker-project.org</p>
</dd>
<dt><code>r_source</code></dt>
<dd>
<p>Whether the R code will be from a runtime file within the source or at build time copying over from a local R file in your session</p>
</dd>
<dt><code>escape_dollar</code></dt>
<dd>
<p>Default TRUE.  This will turn <code>$</code> into <code>$$</code> within the script to avoid them being recognised as Cloud Build variables.  Turn this off if you want that behaviour (e.g. <code>my_project="$PROJECT_ID"</code>)</p>
</dd>
<dt><code>rscript_args</code></dt>
<dd>
<p>Optional arguments for the R script run by <code>Rscript</code>.</p>
</dd>
<dt><code>r_cmd</code></dt>
<dd>
<p>should 'Rscript' be run or 'R'?</p>
</dd>
<dt><code>prefix</code></dt>
<dd>
<p>prefixed to name - set to "" to suppress.  Will be suppressed if <code>name</code> starts with gcr.io or <code>*-docker.pkg.dev</code></p>
</dd>
</dl>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>schedule_type</code></td>
<td>
<p>If you have specified a schedule, this will select what strategy it will use to deploy it. See details</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>schedule_pubsub</code></td>
<td>
<p>If you have a custom pubsub message to send via an existing topic, use cr_schedule_pubsub to supply it here</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>email</code></td>
<td>
<p>The email that will authenticate the job set via cr_email_set</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>region</code></td>
<td>
<p>The region usually set with cr_region_set</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>projectId</code></td>
<td>
<p>ID of the project</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>serviceAccount</code></td>
<td>
<p>service account email to be used for the build</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>launch_browser</code></td>
<td>
<p>Whether to launch the logs URL in a browser once deployed</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The R script will execute within the root directory of whichever Source you supply, usually created via cr_build_source representing a Cloud Storage bucket or a GitHub repository that is copied across before code execution.  Bear in mind if the source changes then the code scheduled may need updating.
</p>
<p>The <code>r_image</code> dictates what R libraries the R environment executing the code of <code>r</code> will have, via the underlying Docker container usually supplied by rocker-project.org.  If you want custom R libraries beyond the default, create a docker container with those R libraries installed (perhaps via cr_deploy_docker)
</p>


<h3>Value</h3>

<p>If scheduling then a Job, if building immediately then a Build
</p>


<h3>Scheduling</h3>

<p>If <code>schedule=NULL</code> then the R script will be run immediately on Cloud Build via cr_build.
</p>
<p>If <code>schedule</code> carries a cron job string (e.g. <code>"15 5 * * *"</code>) then the build will be scheduled via Cloud Scheduler
</p>
<p>If <code>schedule_type="pubsub"</code> then you will need <code>googlePubsubR</code> installed and set-up and scheduling will involve:
</p>

<ol>
<li>
<p> Creating a PubSub topic called <code>"{run_name}-topic"</code> or subscribing to the one you provided in <code>schedule_pubsub</code>.  It is assumed you have created the PubSub topic beforehand if you do supply your own.
</p>
</li>
<li>
<p> Create a Build Trigger called <code>"{run_name}-trigger"</code> that will run when the PubSub topic is called
</p>
</li>
<li>
<p> Create a Cloud Schedule called <code>"{run_name}-trigger"</code> that will send a pubsub message to the topic: either the default that contains just the name of the script, or the message you supplied in <code>schedule_pubsub</code>.
</p>
</li>
</ol>
<p>Type "pubsub" is recommended for more complex R scripts as you will have more visibility for debugging schedules via inspecting the PubSub topic, build trigger and build logs, as well as enabling triggering the script from other PubSub topics and allowing to pass dynamic parameters into your schedule scripts via the PubSub message.
</p>
<p>If <code>schedule_type="http"</code> then scheduling will involve:
</p>

<ol>
<li>
<p> Create a Cloud Build API call with your build embedded within it via cr_schedule_http
</p>
</li>
<li>
<p> Schedule the HTTP call using the authentication email supplied in <code>email</code> or the default cr_email_get
</p>
</li>
</ol>
<p>This is the old default and is suitable for smaller R scripts or when you don't want to use the other  GCP services.  The authentication for the API call from Cloud Scheduler can cause opaque errors as it will give you invalid response codes whether its that or an error in your R script you wish to schedule.
</p>


<h3>See Also</h3>

<p>If you want to run R code upon certain events like GitHub pushes, look at cr_buildtrigger
</p>
<p>Other Deployment functions: 
<code>cr_deploy_docker_trigger()</code>,
<code>cr_deploy_docker()</code>,
<code>cr_deploy_packagetests()</code>,
<code>cr_deploy_pkgdown()</code>,
<code>cr_deploy_run_website()</code>,
<code>cr_deploy_run()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">
r_lines &lt;- c(
  "list.files()",
  "library(dplyr)",
  "mtcars %&gt;% select(mpg)",
  "sessionInfo()"
)
source &lt;- cr_build_source(RepoSource("googleCloudStorageR",
  branchName = "master"
))
## Not run: 
cr_project_set("my-project")
cr_region_set("europe-west1")
cr_email_set("123456@projectid.iam.gserviceaccount.com")

# check the script runs ok
cr_deploy_r(r_lines, source = source)

# schedule the script
cr_deploy_r(r_lines, schedule = "15 21 * * *", source = source)

## End(Not run)

</code></pre>


</div>