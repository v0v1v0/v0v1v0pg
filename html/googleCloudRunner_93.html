<div class="container">

<table style="width: 100%;"><tr>
<td>cr_build_schedule_http</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Create a Cloud Scheduler HTTP target from a Cloud Build object</h2>

<h3>Description</h3>

<p>This enables Cloud Scheduler to trigger Cloud Builds
</p>


<h3>Usage</h3>

<pre><code class="language-R">cr_build_schedule_http(
  build,
  email = cr_email_get(),
  projectId = cr_project_get()
)

cr_schedule_http(build, email = cr_email_get(), projectId = cr_project_get())

cr_schedule_pubsub(
  topicName,
  PubsubMessage = NULL,
  data = NULL,
  attributes = NULL,
  projectId = cr_project_get()
)

cr_schedule(
  name,
  schedule = NULL,
  httpTarget = NULL,
  pubsubTarget = NULL,
  description = NULL,
  overwrite = FALSE,
  timeZone = Sys.timezone(),
  region = cr_region_get(),
  projectId = cr_project_get()
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>build</code></td>
<td>
<p>A Build object created via cr_build_make or cr_build</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>email</code></td>
<td>
<p>The email that will authenticate the job set via cr_email_set</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>projectId</code></td>
<td>
<p>The GCP project to run within usually set with cr_project_set</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>topicName</code></td>
<td>
<p>The name of the Cloud Pub/Sub topic or a Topic object from topics_get</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>PubsubMessage</code></td>
<td>
<p>A <code>PubsubMessage</code> object generated via PubsubMessage.  If used, then do not send in 'data' or 'attributes' arguments as will be redundant since this variable will hold the information.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>The message payload for PubsubMessage. An R object that will be turned into JSON via [jsonlite] and then base64 encoded into the PubSub format.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>attributes</code></td>
<td>
<p>Attributes for PubsubMessage.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>name</code></td>
<td>
<p>Name to call your scheduled job</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>schedule</code></td>
<td>
<p>A cron schedule e.g. <code>"15 5 * * *"</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>httpTarget</code></td>
<td>
<p>A HTTP target object HttpTarget</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pubsubTarget</code></td>
<td>
<p>A Pub/Sub target object PubsubTarget such as created via cr_schedule_pubsub</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>description</code></td>
<td>
<p>Optionally caller-specified in CreateJob or</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>overwrite</code></td>
<td>
<p>If TRUE and an existing job with the same name exists, will overwrite it with the new parameters</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>timeZone</code></td>
<td>
<p>Specifies the time zone to be used in interpreting schedule. If set to <code>NULL</code> will be "UTC". Note that some time zones include a provision for daylight savings time.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>region</code></td>
<td>
<p>The region usually set with cr_region_set</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Ensure you have a service email with cr_email_set of format <code>service-{project-number}@gcp-sa-cloudscheduler.iam.gserviceaccount.com</code> with Cloud Scheduler Service Agent role as per https://cloud.google.com/scheduler/docs/http-target-auth#add
</p>
<p>You can parametrise builds by sending in values within PubSub. To read the data in the message set a substitution variable that picks up the data.  For example <code>_VAR1=$(body.message.data.var1)</code>
</p>
<p>If your schedule to PubSub fails with a permission error, try turning the Cloud Scheduler API off and on again the Cloud Console, which will refresh the Google permissions.
</p>


<h3>Value</h3>

<p><code>cr_schedule_http</code> returns a HttpTarget object for use in cr_schedule
</p>
<p><code>cr_schedule_pubsub</code> returns a PubsubTarget object for use within cr_schedule or cr_schedule_build
</p>
<p>A <code>gar_scheduleJob</code> class object
</p>


<h3>See Also</h3>

<p>https://cloud.google.com/build/docs/api/reference/rest/v1/projects.builds/create
</p>
<p><a href="https://cloud.google.com/scheduler/docs/reference/rest/v1/projects.locations.jobs/create">Google Documentation for Cloud Scheduler</a>
</p>
<p>Other Cloud Scheduler functions: 
<code>HttpTarget()</code>,
<code>Job()</code>,
<code>PubsubTarget()</code>,
<code>cr_run_schedule_http()</code>,
<code>cr_schedule_delete()</code>,
<code>cr_schedule_get()</code>,
<code>cr_schedule_list()</code>,
<code>cr_schedule_pause()</code>,
<code>cr_schedule_run()</code>
</p>
<p>Other Cloud Scheduler functions: 
<code>HttpTarget()</code>,
<code>Job()</code>,
<code>PubsubTarget()</code>,
<code>cr_run_schedule_http()</code>,
<code>cr_schedule_delete()</code>,
<code>cr_schedule_get()</code>,
<code>cr_schedule_list()</code>,
<code>cr_schedule_pause()</code>,
<code>cr_schedule_run()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">cloudbuild &lt;- system.file("cloudbuild/cloudbuild.yaml", package = "googleCloudRunner")
build1 &lt;- cr_build_make(cloudbuild)
build1
## Not run: 
cr_schedule("cloud-build-test1",
  schedule = "15 5 * * *",
  httpTarget = cr_schedule_http(build1)
)

# a cloud build you would like to schedule
itworks &lt;- cr_build("cloudbuild.yaml", launch_browser = FALSE)

# once working, pass in the build to the scheduler
cr_schedule("itworks-schedule",
  schedule = "15 5 * * *",
  httpTarget = cr_schedule_http(itworks)
)

## End(Not run)
cr_project_set("my-project")
cr_bucket_set("my-bucket")
cloudbuild &lt;- system.file("cloudbuild/cloudbuild.yaml",
  package = "googleCloudRunner"
)
bb &lt;- cr_build_make(cloudbuild)
## Not run: 
# create a pubsub topic either in Google Console webUI or library(googlePubSubR)
library(googlePubsubR)
pubsub_auth()
topics_create("test-topic")

## End(Not run)

# create build trigger that will watch for messages to your created topic
pubsub_trigger &lt;- cr_buildtrigger_pubsub("test-topic")
pubsub_trigger
## Not run: 
# create the build trigger with in-line build
cr_buildtrigger(bb, name = "pubsub-triggered", trigger = pubsub_trigger)


# create scheduler that calls the pub/sub topic
cr_schedule("cloud-build-pubsub",
  "15 5 * * *",
  pubsubTarget = cr_schedule_pubsub("test-topic")
)

## End(Not run)

# builds can be also parametrised to respond to parameters within your pubsub topic
# this cloudbuild echos back the value sent in 'var1'
cloudbuild &lt;- system.file("cloudbuild/cloudbuild_substitutions.yml",
  package = "googleCloudRunner"
)
the_build &lt;- cr_build_make(cloudbuild)

# var1 is sent via Pubsub to the buildtrigger
message &lt;- list(var1 = "hello mum")
send_me &lt;- jsonlite::base64_enc(jsonlite::toJSON(message))

# create build trigger that will work from pub/subscription
pubsub_trigger &lt;- cr_buildtrigger_pubsub("test-topic")
## Not run: 
cr_buildtrigger(the_build, name = "pubsub-triggered-subs", trigger = pubsub_trigger)

# create scheduler that calls the pub/sub topic with a parameter
cr_schedule("cloud-build-pubsub",
  "15 5 * * *",
  pubsubTarget = cr_schedule_pubsub("test-topic",
    data = send_me
  )
)

## End(Not run)

## Not run: 
cr_project_set("my-project")
cr_region_set("europe-west1")
cr_schedule("test",
      "* * * * *",
      httpTarget = HttpTarget(uri="https://code.markedmondson.me"))

# schedule a cloud build (no source)
build1 &lt;- cr_build_make("cloudbuild.yaml")
cr_schedule("cloud-build-test", "15 5 * * *",
             httpTarget = cr_schedule_http(build1))

# schedule a cloud build with code source from GCS bucket
my_gcs_source &lt;- cr_build_upload_gcs("my_folder", bucket = cr_get_bucket())
build &lt;- cr_build_make("cloudbuild.yaml", source = my_gcs_source)
cr_schedule("cloud-build-test2", "15 5 * * *",
            httpTarget = cr_schedule_http(build))

# update a schedule with the same name - only supply what you want to change
cr_schedule("cloud-build-test2", "12 6 * * *", overwrite=TRUE)

# By default will use the timezone as specified by Sys.timezone() - change
# this by supplying it directly
cr_schedule("timzone-utc", "12 2 * * *", timeZone = "UTC")

# schedule private Cloud Run app
# for authenticated Cloud Run apps - create with allowUnauthenticated=FALSE
cr_deploy_run("my-app", allowUnauthenticated = TRUE)

# deploying via R will help create a service email called my-app-invoker
cr_run_email("my-app")
#&gt; "my-app-invoker@your-project.iam.gserviceaccount.com"

# schedule the endpoint
my_app &lt;- cr_run_get("my-app")

endpoint &lt;- paste0(my_app$status$url, "/fetch_stuff")

app_sched &lt;- cr_run_schedule_http(endpoint, http_method = "GET",
                                  email = cr_run_email("my-app"))

cr_schedule("my-app-scheduled-1", schedule = "16 4 * * *",
            httpTarget = app_sched)


# creating build triggers that respond to pubsub events

\dontrun{
# create a pubsub topic either in webUI or via library(googlePubSubR)
library(googlePubsubR)
pubsub_auth()
topics_create("test-topic")
}

# create build trigger that will work from pub/subscription
pubsub_trigger &lt;- cr_buildtrigger_pubsub("test-topic")
pubsub_trigger

\dontrun{
# create the build trigger with in-line build
cr_buildtrigger(bb, name = "pubsub-triggered", trigger = pubsub_trigger)
# create scheduler that calls the pub/sub topic

cr_schedule("cloud-build-pubsub",
            "15 5 * * *",
            pubsubTarget = cr_schedule_pubsub("test-topic"))

}


## End(Not run)
</code></pre>


</div>