<div class="container">

<table style="width: 100%;"><tr>
<td>stat_multcomp</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Labels for pairwise multiple comparisons</h2>

<h3>Description</h3>

<p><code>stat_multcomp</code> fits a linear model by default with <code>stats::lm()</code>
but alternatively using other model fit functions. The model is passed to
function <code>glht()</code> from package 'multcomp' to fit Tukey, Dunnet or other
<strong>pairwise</strong> contrasts and generates labels based on adjusted
<em>P</em>-values.
</p>


<h3>Usage</h3>

<pre><code class="language-R">stat_multcomp(
  mapping = NULL,
  data = NULL,
  geom = NULL,
  position = "identity",
  ...,
  formula = NULL,
  method = "lm",
  method.args = list(),
  contrasts = "Tukey",
  p.adjust.method = NULL,
  small.p = getOption("ggpmisc.small.p", default = FALSE),
  adj.method.tag = 4,
  p.digits = 3,
  label.type = "bars",
  fm.cutoff.p.value = 1,
  mc.cutoff.p.value = 1,
  mc.critical.p.value = 0.05,
  label.y = NULL,
  vstep = NULL,
  output.type = NULL,
  na.rm = FALSE,
  orientation = "x",
  parse = NULL,
  show.legend = FALSE,
  inherit.aes = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>mapping</code></td>
<td>
<p>The aesthetic mapping, usually constructed with
<code>aes</code>. Only needs to be
set at the layer level if you are overriding the plot defaults.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>A layer specific dataset, only needed if you want to override
the plot defaults.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>geom</code></td>
<td>
<p>The geometric object to use to display the data.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>position</code></td>
<td>
<p>The position adjustment to use for overlapping points on this
layer.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>other arguments passed on to <code>layer</code>. This
can include aesthetics whose values you want to set, not map. See
<code>layer</code> for more details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>formula</code></td>
<td>
<p>a formula object. Using aesthetic names <code>x</code> and <code>y</code>
instead of original variable names.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p>function or character If character, "lm" (or its equivalent
"aov"), "rlm" or the name of a model fit function are accepted, possibly
followed by the fit function's <code>method</code> argument separated by a colon
(e.g. <code>"rlm:M"</code>). If a function different to <code>lm()</code>, it must
accept as a minimum a model formula through its first parameter, and have
formal parameters named <code>data</code>, <code>weights</code>, and <code>method</code>, and
return a model fit object accepted by function <code>glht()</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method.args</code></td>
<td>
<p>named list with additional arguments.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>contrasts</code></td>
<td>
<p>character vector of length one or a numeric matrix. If
character, one of "Tukey" or "Dunnet". If a matrix, one column per level
of the factor mapped to <code>x</code> and one row per <strong>pairwise</strong>
contrast.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>p.adjust.method</code></td>
<td>
<p>character As the argument for parameter <code>type</code> of
function <code>adjusted()</code> passed as argument to parameter <code>test</code> of
<code>summary.glht</code>. Accepted values are "single-step",
"Shaffer", "Westfall", "free", "holm", "hochberg", "hommel", "bonferroni",
"BH", "BY", "fdr", "none".</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>small.p</code></td>
<td>
<p>logical If true, use of lower case <em>p</em> instead of capital
<em>P</em> as the symbol for <em>P</em>-value in labels.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>adj.method.tag</code></td>
<td>
<p>numeric, character or function If <code>numeric</code>, the
length in characters of the abbreviation of the method used to adjust
<em>p</em>-values. A value of zero, adds no label and a negative value uses
as starting point for the abbreviation the word "adjusted". If
<code>character</code> its value is used as subscript. If a <code>function</code>, the
value used is the value returned by the function when passed
<code>p.adjust.method</code> as its only argument.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>p.digits</code></td>
<td>
<p>integer Number of digits after the decimal point to
use for <code class="reqn">R^2</code> and <em>P</em>-value in labels.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>label.type</code></td>
<td>
<p>character One of "bars", "letters" or "LETTERS", selects
how the results of the multiple comparisons are displayed. Only "bars" can
be used together with <code>contrasts = "Dunnet"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fm.cutoff.p.value</code></td>
<td>
<p>numeric [0..1] The <em>P</em>-value for the main
effect of factor <code>x</code> in the ANOVA test for the fitted model above
which no pairwise comparisons are computed or labels generated. Be aware
that recent literature tends to recommend to consider which testing
approach is relevant to the problem at hand instead of requiring the
significance of the main effect before applying multiple comparisons'
tests. The default value is 1, imposing no restrictions.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mc.cutoff.p.value</code></td>
<td>
<p>numeric [0..1] The <em>P</em>-value for the individual
contrasts above which no labelled bars are generated. Default is 1,
labelling all pairwise contrasts tested.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mc.critical.p.value</code></td>
<td>
<p>numeric The critical <em>P</em>-value used for tests
when encoded as letters.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>label.y</code></td>
<td>
<p>numeric vector Values in native data units or if
<code>character</code>, one of "top" or "bottom". Recycled if too short and
truncated if too long.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>vstep</code></td>
<td>
<p>numeric in npc units, the vertical displacement step-size
used between labels for different contrasts when <code>label.type = "bars"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>output.type</code></td>
<td>
<p>character One of "expression", "LaTeX", "text",
"markdown" or "numeric".</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>na.rm</code></td>
<td>
<p>a logical indicating whether NA values should be stripped before
the computation proceeds.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>orientation</code></td>
<td>
<p>character Either "x" or "y" controlling the default for
<code>formula</code>. <strong>Support for <code>orientation</code> is not yet
implemented but is planned.</strong></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>parse</code></td>
<td>
<p>logical Passed to the geom. If <code>TRUE</code>, the labels will be
parsed into expressions and displayed as described in <code>?plotmath</code>.
Default is <code>TRUE</code> if <code>output.type = "expression"</code> and
<code>FALSE</code> otherwise.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>show.legend</code></td>
<td>
<p>logical. Should this layer be included in the legends?
<code>NA</code>, the default, includes if any aesthetics are mapped. <code>FALSE</code>
never includes, and <code>TRUE</code> always includes.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>inherit.aes</code></td>
<td>
<p>If <code>FALSE</code>, overrides the default aesthetics, rather
than combining with them.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>This statistic can be used to automatically annotate a plot with
<em>P</em>-values for <strong>pairwise</strong> multiple comparison tests, based on
Tukey contrasts (all pairwise), Dunnet contrasts (other levels against the
first one) or a subset of all possible pairwise contrasts. See Meier (2022,
Chapter 3) for an accessible explanation of multiple comparisons and
contrasts with package 'multcomp', of which <code>stat_multcomp()</code> is
mostly a wrapper.
</p>
<p>The explanatory variable mapped to the <em>x</em> aesthetic must be a factor
as this creates the required grouping. Currently, contrasts that involve
more than two levels of a factor, such as the average of two treatment
levels against a control level are not supported, mainly because they
require a new geometry that I need to design, implement and add to package
'ggpp'.
</p>
<p>Two ways of displaying the outcomes are implemented, and are selected by
'"bars"', '"letters"' or '"LETTERS"' as argument to parameter
'label.type'. '"letters"' and '"LETTERS"' can be used only with Tukey
contrasts, as otherwise the encoding is ambiguous. As too many bars clutter
a plot, the maximum number of factor levels supported for '"bars"' together
with Tukey contrasts is five, while together with Dunnet contrasts or
contrasts defined by a numeric matrix, no limit is imposed.
</p>
<p><code>stat_multcomp()</code> by default generates character labels ready to be
parsed as R expressions but LaTeX (use TikZ device), markdown (use package
'ggtext') and plain text are also supported, as well as numeric values for
user-generated text labels. The value of <code>parse</code> is set automatically
based on <code>output.type</code>, but if you assemble labels that need parsing
from <code>numeric</code> output, the default needs to be overridden. This
statistic only generates annotation labels and segments connecting the
compared factor levels, or letter labels that discriminate significantly
different groups.
</p>


<h3>Value</h3>

<p>A data frame with one row per comparison for <code>label.type =
  "bars"</code>, or a data frame with one row per factor <code>x</code> level for
<code>label.type = "letters"</code> and for <code>label.type = "LETTERS"</code>.
Variables (= columns) as described under <strong>Computed variables</strong>.
</p>


<h3>Aesthetics</h3>

<p><code>stat_multcomp()</code> understands <code>x</code> and
<code>y</code>, to be referenced in the <code>formula</code> and <code>weight</code> passed
as argument to parameter <code>weights</code>. A factor must be mapped to
<code>x</code> and <code>numeric</code> variables to <code>y</code>, and, if used, to
<code>weight</code>. In addition, the aesthetics understood by the geom
(<code>"label_pairwise"</code> is the default for <code>label.type = "bars"</code>,
<code>"text"</code> is the default for <code>label.type = "letters"</code> and for
<code>label.type = "LETTERS"</code>) are understood and grouping
respected.
</p>


<h3>Computed variables</h3>

<p>If <code>output.type = "numeric"</code> and
<code>label.type = "bars"</code> the returned tibble contains
columns listed below. In all cases if the model fit function used does not return a value,
the label is set to <code>character(0L)</code> and the numeric value to <code>NA</code>.
</p>

<dl>
<dt>x,x.left.tip,x.right.tip</dt>
<dd>
<p>x position, numeric.</p>
</dd>
<dt>y</dt>
<dd>
<p>y position, numeric.</p>
</dd>
<dt>coefficients</dt>
<dd>
<p>Delta estimate from pairwise contrasts, numeric.</p>
</dd>
<dt>contrasts</dt>
<dd>
<p>Contrasts as two levels' ordinal "numbers" separated by a dash, character.</p>
</dd>
<dt>tstat</dt>
<dd>
<p><em>t</em>-statistic estimates for the pairwise contrasts, numeric.</p>
</dd>
<dt>p.value</dt>
<dd>
<p><em>P</em>-value for the pairwise contrasts.</p>
</dd>
<dt>fm.method</dt>
<dd>
<p>Set according <code>method</code> used.</p>
</dd>
<dt>fm.class</dt>
<dd>
<p>Most derived class of the fitted model object.</p>
</dd>
<dt>fm.formula</dt>
<dd>
<p>Formula extracted from the fitted model object if available, or the formula argument.</p>
</dd>
<dt>fm.formula.chr</dt>
<dd>
<p>Formula extracted from the fitted model object if available, or the formula argument, formatted as character.</p>
</dd>
<dt>mc.adjusted</dt>
<dd>
<p>The method used to adjust the <em>P</em>-values.</p>
</dd>
<dt>mc.contrast</dt>
<dd>
<p>The type of contrast used for multiple comparisons.</p>
</dd>
<dt>n</dt>
<dd>
<p>The total number of observations or rows in data.</p>
</dd>
<dt>default.label</dt>
<dd>
<p>text label, always included, but possibly NA.</p>
</dd>
</dl>
<p>If output.type is not <code>"numeric"</code> the returned data frame includes in
addition the following labels:
</p>

<dl>
<dt>stars.label</dt>
<dd>
<p><em>P</em>-value for the pairwise contrasts encoded as "starts", character.</p>
</dd>
<dt>p.value.label</dt>
<dd>
<p><em>P</em>-value for the pairwise contrasts, character.</p>
</dd>
<dt>delta.label</dt>
<dd>
<p>The coefficient or estimate for the difference between compared pairs of levels.</p>
</dd>
<dt>t.value.label</dt>
<dd>
<p><em>t</em>-statistic estimates for the pairwise contrasts, character.</p>
</dd>
</dl>
<p>If <code>label.type = "letters"</code> or <code>label.type = "LETTERS"</code> the returned tibble contains
columns listed below.
</p>

<dl>
<dt>x,x.left.tip,x.right.tip</dt>
<dd>
<p>x position, numeric.</p>
</dd>
<dt>y</dt>
<dd>
<p>y position, numeric.</p>
</dd>
<dt>critical.p.value</dt>
<dd>
<p><em>P</em>-value used in pairwise tests, numeric.</p>
</dd>
<dt>fm.method</dt>
<dd>
<p>Set according <code>method</code> used.</p>
</dd>
<dt>fm.class</dt>
<dd>
<p>Most derived class of the fitted model object.</p>
</dd>
<dt>fm.formula</dt>
<dd>
<p>Formula extracted from the fitted model object if available, or the formula argument.</p>
</dd>
<dt>fm.formula.chr</dt>
<dd>
<p>Formula extracted from the fitted model object if available, or the formula argument, formatted as character.</p>
</dd>
<dt>mc.adjusted</dt>
<dd>
<p>The method used to adjust the <em>P</em>-values.</p>
</dd>
<dt>mc.contrast</dt>
<dd>
<p>The type of contrast used for multiple comparisons.</p>
</dd>
<dt>n</dt>
<dd>
<p>The total number of observations or rows in data.</p>
</dd>
<dt>default.label</dt>
<dd>
<p>text label, always included, but possibly NA.</p>
</dd>
</dl>
<p>If output.type is not <code>"numeric"</code> the returned data frame includes in
addition the following labels:
</p>

<dl>
<dt>letters.label</dt>
<dd>
<p>Letters that distinguish levels based on significance from multiple comparisons test.</p>
</dd>
</dl>
<h3>Alternatives</h3>

<p><code>stat_signif()</code> in package 'ggsignif' is
an earlier and independent implementation of pairwise tests.
</p>


<h3>Note</h3>

<p>R option <code>OutDec</code> is obeyed based on its value at the time the plot
is rendered, i.e., displayed or printed. Set <code>options(OutDec = ",")</code>
for languages like Spanish or French.
</p>


<h3>References</h3>

<p>Meier, Lukas (2022) <em>ANOVA and Mixed Models: A Short Introduction
Using R</em>. Chapter 3 Contrasts and Multiple Testing. The R Series. Boca Raton:
Chapman and Hall/CRC. ISBN: 9780367704209, <a href="https://doi.org/10.1201/9781003146216">doi:10.1201/9781003146216</a>.
</p>


<h3>See Also</h3>

<p>This statistic uses the implementation of Tests of General Linear
Hypotheses in function <code>glht</code>. See
<code>summary.glht</code> and <code>p.adjust</code>
for the supported and tests and the references therein for the theory
behind them.
</p>


<h3>Examples</h3>

<pre><code class="language-R">
p1 &lt;- ggplot(mpg, aes(factor(cyl), hwy)) +
  geom_boxplot(width = 0.33)

## labeleld bars

p1 +
  stat_multcomp()

p1 +
  stat_multcomp(adj.method.tag = 0)

# test against a control, with first level being the control
# change order of factor levels in data to set the control group
p1 +
  stat_multcomp(contrasts = "Dunnet")

# arbitrary pairwise contrasts, in arbitrary order
p1 +
  stat_multcomp(contrasts = rbind(c(0, 0, -1, 1),
                                  c(0, -1, 1, 0),
                                  c(-1, 1, 0, 0)))

# different methods to adjust the contrasts
p1 +
  stat_multcomp(p.adjust.method = "bonferroni")

p1 +
  stat_multcomp(p.adjust.method = "holm")

p1 +
  stat_multcomp(p.adjust.method = "fdr")

# no correction, useful only for comparison
p1 +
  stat_multcomp(p.adjust.method = "none")

# sometimes we need to expand the plotting area
p1 +
  stat_multcomp(geom = "text_pairwise") +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.10)))

# position of contrasts' bars (based on scale limits)
p1 +
  stat_multcomp(label.y = "bottom")

p1 +
  stat_multcomp(label.y = 11)

# use different labels: difference and P-value from hypothesis tests
p1 +
  stat_multcomp(use_label("Delta", "P"),
                size = 2.75)

# control smallest P-value displayed and number of digits
p1 +
  stat_multcomp(p.digits = 4)

# label only significant differences
# but test and correct for all pairwise contrasts!
p1 +
  stat_multcomp(mc.cutoff.p.value = 0.01)

## letters as labels for test results

p1 +
  stat_multcomp(label.type = "letters")

# use capital letters
p1 +
  stat_multcomp(label.type = "LETTERS")

# location
p1 +
  stat_multcomp(label.type = "letters",
                label.y = "top")

p1 +
  stat_multcomp(label.type = "letters",
                label.y = 0)

# stricter critical p-value than default used for test
p1 +
  stat_multcomp(label.type = "letters",
                mc.critical.p.value = 0.01)

# Inspecting the returned data using geom_debug()
# This provides a quick way of finding out the names of the variables that
# are available for mapping to aesthetics with after_stat().

gginnards.installed &lt;- requireNamespace("gginnards", quietly = TRUE)

if (gginnards.installed)
  library(gginnards)

if (gginnards.installed)
p1 +
  stat_multcomp(label.type = "bars",
                geom = "debug")

if (gginnards.installed)
p1 +
  stat_multcomp(label.type = "letters",
                geom = "debug")

if (gginnards.installed)
p1 +
  stat_multcomp(label.type = "bars",
                output.type = "numeric",
                geom = "debug")

</code></pre>


</div>