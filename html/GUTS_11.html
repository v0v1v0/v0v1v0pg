<div class="container">

<table style="width: 100%;"><tr>
<td>GUTS</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Fast Calculation of the Likelihood of a Stochastic Survival Model</h2>

<h3>Description</h3>

<p>GUTS (General Unified Threshold model of Survival) is a stochastic survival model for ecotoxicology. The package allows for the definition of exposure and survival time series as well as parameter values, and the fast calculation of the survival probabilities as well as the logarithm of the corresponding likelihood.
</p>
<p>The package implements the GUTS-SIC (also called GUTS-RED) variants that assume a one-compartment model with first-order toxicokinetics.</p>


<h3>Usage</h3>

<pre><code class="language-R">guts_setup(C, Ct, y, yt, dist = "lognormal",
	model = "Proper",
	N = 1000L,
	MF = 100L,
	M = max(
		5000L,
		as.integer(ceiling(MF * length(union(Ct, yt)))),
		as.integer(ceiling(MF * max(union(Ct, yt))))
		),
	SVR = 1L,
	study = "", Clevel = ""
	)

guts_calc_loglikelihood(gobj, par, external_dist = NULL,
  use_multinomial_coefficient = FALSE)

guts_calc_survivalprobs(gobj, par, external_dist = NULL)

guts_report_damage(gobj)

guts_report_sppe(gobj)

guts_report_squares(gobj)
</code></pre>


<h3>Arguments</h3>


<table>
<tr style="vertical-align: top;">
<td><code>C</code></td>
<td>
<p>Numeric vector of concentrations.  Vector must contain at least 2 values and be of the same length as <code>Ct</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Ct</code></td>
<td>
<p>Numeric vector of concentration time points.  Vector must contain at least 2 values and be of the same length as <code>C</code>. Time points must start at 0, and contain unique values in ascending order.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>y</code></td>
<td>
<p>Integer vector (counts) of survivors.  Vector must contain at least 2 values and be of the same length as <code>yt</code>.  <code>y</code> must not be ascending.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>yt</code></td>
<td>
<p>Numeric vector of survivor time points.  Vector must contain at least 2 values and be of the same length as <code>y</code>. Time points must start at 0, and contain unique values in ascending order.  Survivor information at time points later than the latest concentration time point will be disregarded (with a warning).
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dist</code></td>
<td>
<p>Distribution as character, either “lognormal” (default), “loglogistic”, “external” or “delta”.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model</code></td>
<td>
<p>Model as character, either “Proper” (for full model, the default), “IT” (for individual tolerance), or “SD” (for stochastic death).
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>MF</code></td>
<td>
<p>Integer.  Multiplication factor for M.  Must be greater than 1. MF is used only if “model = 'SD'” or “model = 'Proper'” and M is not specified. Setting MF automatically ensures that the number of points for time discretization M is at least the number of measurement time steps or the measurement time (which ever is larger) multiplied by MF. A minimum of <code>M = 5000</code> is ensured.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>M</code></td>
<td>
<p>Integer.  Desired number of points for time discretization.  Must be greater than 1. M is used only if “model = 'SD'” or “model = 'Proper'”
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>N</code></td>
<td>
<p>Integer.  Sample length of individual tolerance thresholds. Must be greater than 2. N is used only, if “model = 'Proper'”
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>study</code></td>
<td>
<p>string with the name of the study</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Clevel</code></td>
<td>
<p>character vector with names for each of the concentraton levels</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>SVR</code></td>
<td>
<p>Numeric surface-volume-ratio. A multiplication factor to kd.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gobj</code></td>
<td>
<p>GUTS object.  The object to be updated (and used for the calculation).
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>par</code></td>
<td>
<p>Numeric vector of parameters.  See details below.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>external_dist</code></td>
<td>
<p>Numeric vector containing the distribution of individual thresholds. Only used if <code>dist = 'external'</code>. See details below.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>use_multinomial_coefficient</code></td>
<td>
<p>If “TRUE” returns loglikelihood from the correct multinomial distribution. Defaults to ignoring the constant multinomial coefficient for performance reasons.
</p>
</td>
</tr>
</table>
<h3>Details</h3>




<h4>Functions</h4>


<p>Use <code>guts_setup</code> to define (or alter) a GUTS object. Various checks are applied to the data. On success, a GUTS object will be created.
</p>
<p>Use <code>guts_calc_loglikelihood</code> to calculate the survival probabilities and the corresponding loglikelihood for a given set of parameters.  The function is very fast and can be used in routines for parameter estimation.  The function returns the loglikelihood, however it also updates the fields <code>par</code>, <code>S</code>, <code>D</code>, <code>SPPE</code>, <code>squares</code>, <code>zt</code> and <code>LL</code> of the GUTS-object.
</p>
<p><code>guts_calc_survivalprobs</code> is a convenience wrapper that can be used for predictions; it returns the survival probabilities, however it also updates the fields <code>par</code>, <code>S</code>, <code>D</code>, <code>SPPE</code>, <code>squares</code>, <code>zt</code> and <code>LL</code> of the GUTS-object.
</p>
<p><code>guts_report_damage</code> returns a data.frame with time grid points and the damage for each of these. The function reports the damage that was calculated in the previous call to <code>guts_calc_loglikelihood</code> or <code>guts_calc_survivalprobs</code>.
</p>
<p><code>guts_report_squares</code> returns the sum of squares. The function reports the sum of squares that was calculated in the previous call to <code>guts_calc_loglikelihood</code> or <code>guts_calc_survivalprobs</code>.
</p>
<p><code>guts_report_sppe</code> returns the survival-probability prediction error (SPPE). The function reports the SPPE that was calculated in the previous call to <code>guts_calc_loglikelihood</code> or <code>guts_calc_survivalprobs</code>.
</p>



<h4> Models, Parameters, and Distributions</h4>


<p>The GUTS package provides three model types:
</p>

<ul>
<li>
<p> Proper: a GUTS-SIC-Proper (also called GUTS-RED-Proper) model using random individual tolerances and a stochastic death process, when individual tolerances are exceeded.
</p>
</li>
<li>
<p> IT: a GUTS-SIC-IT (GUTS-RED-IT) individual tolerance model using random individual tolerances. If an individual's tolerance threshold is exceeded, the individual dies.
</p>
</li>
<li>
<p> SD: a GUTS-SIC-SD (GUTS-RED-SD) stochastic death model using a stochastic death process above a population-wide tolerance threshold. The tolerance-threshold is the same for all individuals.
</p>
</li>
</ul>
<p>The Proper GUTS model requires the following parameters <code>par</code>, while variants IT and SD are based on a reduced subset (as indicated in brackets). Parameter values in <code>par</code> must be ordered as listed here:
</p>

<ul>
<li>
<p> hb: background mortality rate (Proper, IT, SD)
</p>
</li>
<li>
<p> ke: dominant rate constant (Proper, IT, SD)
</p>
</li>
<li>
<p> kk: killing rate (Proper, SD)
</p>
</li>
<li>
<p> further parameters for the tolerance threshold (in SD) or the threshold distribution <code>dist</code> (in Proper and IT)
</p>
</li>
</ul>
<p>For model type “SD” (stochastic death), required parameters <code>par[1:4]</code> are <code>hb</code>, <code>ke</code>, <code>kk</code> and <code>mn</code>, which is the population-wide tolerance threshold. For backwards compatibility this model type can be initiated setting <code>dist = "Delta"</code> and <code>model = "Proper"</code>.
</p>
<p>For model type “IT” (individual tolerance), required parameters <code>par[1:2]</code> are <code>hb</code>, <code>ke</code>, as well as respective distribution parameters (from <code>par[3]</code> onwards). Parameter (<code>kk</code>) is set internally to infinity and does not need to be provided.
</p>
<p>For model type “Proper”, all parameters are needed. <code>par[1:3]</code> take <code>hb</code>, <code>ke</code>, <code>kk</code>, distribution parameters follow (from <code>par[4]</code> onwards).
</p>
<p>For model types “Proper” and “IT” individual tolerance thresholds are created internally. Individual tolerances are drawn from the specified distribution <code>dist</code>. The parameter values required depend on the specified <code>dist</code>:
</p>

<ul>
<li>
<p> "lognormal": requires the parameters <code>mn</code> and <code>sd</code> which are the mean and standard deviation of the lognormal random distribution. In contrast to parameters <code>meanlog</code> and <code>sdlog</code> of function <code>dlnorm</code>, these parameters are not on the logscale. They relate in the following way:
</p>
<p style="text-align: center;"><code class="reqn">sdlog = \sqrt{\ln{\frac{1 + sd^2}{mn^2}}}</code>
</p>

<p style="text-align: center;"><code class="reqn">meanlog = \ln{mn} - \frac{1}{2} * sdlog^2</code>
</p>

</li>
<li>
<p> "loglogistic": requires the parameters <code class="reqn">mn = scale = median</code> and <code class="reqn">beta = shape</code>.
</p>
</li>
<li>
<p> "external": uses random variates provided to <code>external_dist</code>. With this option GUTS can be run with arbitrarily distributed individual tolerance thresholds. With the option “external” only parameters <code>hb</code>, <code>ke</code> and <code>kk</code> (Proper only) are required. Further, the thresholds sample length <code>N</code> is internally adjusted to the length of the external vector of random variates <code>external_dist</code>. The adjustment of <code>N</code> is notified by a warning.
</p>
</li>
</ul>
<p>For performance reasons the implemented distributions “lognormal”  and “loglogistic” are approximated using importance sampling. The option “external” generally performs well, but might require a larger thresholds sample (i.e. <code>length(external_dist)</code> should be large).
</p>
<p>The number of parameters is checked according to <code>dist</code> and <code>model</code>.  Wrong number of parameters invokes an error, wrong parameter values (e.g., negative values) invoke a warning, and the loglikelihood is set to <code>-Inf</code>.
</p>
 


<h4>Field and Attribute Access</h4>


<p>Fields and attributes of an object of class “GUTS” are read-only.  It is not possible to directly modify single elements of the GUTS object.  Instead use function <code>guts_setup</code> to create GUTS objects or modify fields on existing GUTS objects. Functions <code>guts_calc_loglikelihood</code> and <code>guts_calc_survivalprobs</code> update an object's fields <code>par</code> (parameters), <code>D</code> (damage), <code>squares</code> (sum of squares), <code>SPPE</code> (survival-probability prediction error), <code>S</code> (survival probabilities) and <code>LL</code> (the loglikelihood).
</p>
 


<h3>Value</h3>

<p><code>guts_setup</code> returns a list of class “GUTS” with the following fields:
</p>
<table>
<tr style="vertical-align: top;">
<td><code>C</code></td>
<td>
<p>Concentrations.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Ct</code></td>
<td>
<p>Concentration time points.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>y</code></td>
<td>
<p>Survivors.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>yt</code></td>
<td>
<p>Survivor time points.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dist</code></td>
<td>
<p>Distribution.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model</code></td>
<td>
<p>Model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>N</code></td>
<td>
<p>Sample length.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>M</code></td>
<td>
<p>Time grid points.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>par</code></td>
<td>
<p>Parameters.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>S</code></td>
<td>
<p>Vector of survivor probabilities.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>D</code></td>
<td>
<p>Vector of internal damage for each of the <code>M</code> time grid points.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>squares</code></td>
<td>
<p>Sum of squares</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>SPPE</code></td>
<td>
<p>Survival-probability prediction error.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>LL</code></td>
<td>
<p>The loglikelihood.</p>
</td>
</tr>
</table>
<p><code>guts_calc_loglikelihood</code> returns the loglikelihood.
</p>
<p><code>guts_calc_survivalprobs</code> returns the survival probabilities.
</p>
<p><code>guts_report_damage</code> returns the damage.
</p>
<p><code>guts_report_squares</code> returns the sum of squares.
</p>
<p><code>guts_report_sppe</code> returns the survival-probability prediction error (SPPE).
</p>


<h3>Note</h3>


<p>The GUTS project web site can be found here: <a href="http://guts.r-forge.r-project.org">http://guts.r-forge.r-project.org</a>.  For questions and discussion, please subscribe to the mailing list there.
</p>


<h3>Author(s)</h3>

<p>Carlo Albert <a href="mailto:carlo.albert@eawag.ch">carlo.albert@eawag.ch</a>, Sören Vogel <a href="mailto:soeren.vogel@posteo.ch">soeren.vogel@posteo.ch</a>, Oliver Jakoby <a href="mailto:oliver.jakoby@rifcon.de">oliver.jakoby@rifcon.de</a>, Alexander Singer <a href="mailto:alexander.singer@rifcon.de">alexander.singer@rifcon.de</a> and Dirk Nickisch <a href="mailto:dirk.nickisch@rifcon.de">dirk.nickisch@rifcon.de</a>
</p>
<p>Maintainer: Oliver Jakoby <a href="mailto:oliver.jakoby@rifcon.de">oliver.jakoby@rifcon.de</a></p>


<h3>References</h3>

<p>Albert, C., Vogel, S., and Ashauer, R. (2016). Computationally efficient implementation of a novel algorithm for the General Unified Threshold Model of Survival (GUTS). PLOS Computational Biology, 12(6), e1004978. <a href="https://doi.org/10.1371/journal.pcbi.1004978">doi:10.1371/journal.pcbi.1004978</a>.
</p>
<p>Jager, T., Albert, C., Preuss, T., and Ashauer, R. (2011). General Unified Threshold Model of Survival – a toxicokinetic toxicodynamic framework for ecotoxicology. Environmental Science &amp; Technology, 45(7), 2529–2540, <a href="https://doi.org/10.1021/es103092a">doi:10.1021/es103092a</a>.
</p>
<p>Ashauer, R., Albert, C., Augustine, S., Cedergreen, N., Charles, S., Ducrot, V., Focks, A., Gabsi, F., Gergs, A., Goussen, B., Jager, T., Kramer, N.I., Nyman, A.-M., Poulsen, V., Reichenberger, S., Schäfer, R.B., Van den Brink, P.J., Veltman, K., Vogel, S., Zimmer, E.I., Preuss, T.G. (2016) Modelling survival: exposure pattern, species sensitivity and uncertainty. Scientific Reports, 6, 1, <a href="https://doi.org/10.1038/srep29178">doi:10.1038/srep29178</a>.
</p>
<p>Jager, T., Ashauer, R. (2018). Modelling survival under chemical stress. A comprehensive guide to the GUTS framework. Leanpub: <a href="https://leanpub.com/guts_book">https://leanpub.com/guts_book</a>, <a href="http://www.debtox.info/book_guts.html">http://www.debtox.info/book_guts.html</a>
</p>
<p>EFSA PPR Panel (EFSA Panel on Plant Protection Products and their Residues), Ockleford, C., Adriaanse, P., Berny, P., Brock, T., Duquesne, S., Grilli, S., Hernandez-Jerez, A.F., Bennekou, S.H., Klein, M., Kuhl, T., Laskowski, R., Machera, K., Pelkonen, O., Pieper, S., Smith, R.H., Stemmer, M., Sundh, I., Tiktak, A., Topping, C.J., Wolterink, G., Cedergreen, N., Charles, S., Focks, A., Reed, M., Arena, M., Ippolito, A., Byers, H. and Teodorovic, I. (2018). Scientific Opinion on the state of the art of Toxicokinetic/Toxicodynamic (TKTD) effect models for regulatory risk assessment of pesticides for aquatic organisms. EFSA Journal, 16(8):5377, 188 pp., <a href="https://doi.org/10.2903/j.efsa.2018.5377">doi:10.2903/j.efsa.2018.5377</a>.
</p>
<p>Gergs, A., Gabsi, F., Zenker, A., Preuss, T. (2011). Demographic toxicokinetic–toxicodynamic modeling of lethal effects. Environmental Science &amp; Technology, 50(11), 6017–6024, <a href="https://doi.org/10.1021/acs.est.6b01113">doi:10.1021/acs.est.6b01113</a>.
</p>
<p>Nickisch, D., Rall, B., Singer, A., Ashauer, R. (2022). Fish Species Sensitivity Ranking Depends on Pesticide Exposure Profiles. Environmental Toxicology &amp; Chemistry, 41, 1732-1741, <a href="https://doi.org/10.1002/etc.5348">doi:10.1002/etc.5348</a>.
</p>
<p>Singer, A., Nickisch, D., Gergs, A. (2023). Joint survival modelling for multiple species exposed to toxicants. Science of The Total Environment, 857, 159266, <a href="https://doi.org/10.1016/j.scitotenv.2022.159266">doi:10.1016/j.scitotenv.2022.159266</a>.
</p>


<h3>See Also</h3>

<p><code>diazinon</code>, <code>GUTS-package</code> and the package vignettes for examples on how to calibrate and project GUTS-models.</p>


<h3>Examples</h3>

<pre><code class="language-R">data(diazinon)

# create GUTS object to calculate the Proper model
#  using a log-normal distribution of tolerance thresholds
gts.lognormal &lt;- guts_setup(
  C = diazinon$C1, Ct = diazinon$Ct1,
  y = diazinon$y1, yt = diazinon$yt1,
  dist = "lognormal", model = "Proper")

# calculate likelihood of Proper model using log-normal distribution
guts_calc_loglikelihood(
  gts.lognormal,
  c(0.051, 0.126, 1.618, 19.099, 6.495))
gts.lognormal  # show GUTS object

# repeating calculation above
#  with threshold values from an external log-normal distribution.
#  Note, we need to account for the different parametrisations
#  used in the GUTS-package and in rlnorm
sigma2 &lt;- log( 1 + 6.495^2 / 19.099^2)
mu &lt;- log(19.099) - 0.5 * sigma2
lognormal.thresholds &lt;- rlnorm(1000, meanlog = mu, sdlog = sqrt(sigma2))
gts.external &lt;- guts_setup(
  C = diazinon$C1, Ct = diazinon$Ct1,
  y = diazinon$y1, yt = diazinon$yt1,
  dist = "external", model = "Proper")
guts_calc_loglikelihood(
  gts.external,
  c(0.051, 0.126, 1.618), external_dist = lognormal.thresholds)
# -&gt; Results using external and internal distributions are comparable

# create GUTS object to calculate the Proper model
#  using a log-logistic distribution of tolerance thresholds
gts.loglogistic &lt;- guts_setup(
  C = diazinon$C1, Ct = diazinon$Ct1,
  y = diazinon$y1, yt = diazinon$yt1,
  dist = "loglogistic", model = "Proper")
guts_calc_survivalprobs( # returning survival probabilities
  gts.loglogistic,
  c(0.01, 0.2, 0.3, 3, 2))

str(guts_report_damage(gts.loglogistic)) # returning damage

# calculate survival probabilities with IT model
#  using a log-logistic distribution of tolerance thresholds
guts_calc_survivalprobs(
  guts_setup(
  C = diazinon$C1, Ct = diazinon$Ct1,
  y = diazinon$y1, yt = diazinon$yt1,
  dist = "loglogistic", model = "IT"),
  c(0.01, 0.2, 3, 2))

# calculate survival probabilities with an SD model with a fixed tolerance threshold
guts_calc_survivalprobs(
  guts_setup(
  C = diazinon$C1, Ct = diazinon$Ct1,
  y = diazinon$y1, yt = diazinon$yt1,
  dist = "loglogistic", model = "SD"),
  c(0.01, 0.2, 0.3, 3))


## Not run: guts_calc_survivalprobs(gts.external, rep(.5, 3))
# Warning and no result, because no external distribution was specified

## Not run: guts_calc_survivalprobs(gts.loglogistic , 1:4 ) # Error.

## Not run: gts.loglogistic[["C"]] &lt;- 1:3 # Error.
</code></pre>


</div>