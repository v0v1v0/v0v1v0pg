<div class="container">

<table style="width: 100%;"><tr>
<td>likelihood_catchdistribution</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Gadget3 likelihood actions</h2>

<h3>Description</h3>

<p>Gather nll in a g3 model
</p>


<h3>Usage</h3>

<pre><code class="language-R">g3l_distribution_sumofsquares(over = c("area"))

g3l_distribution_multinomial(epsilon = 10)

g3l_distribution_multivariate(rho_f, sigma_f, over = c("area"))

g3l_distribution_surveyindices_log(alpha = NULL, beta = 1)

g3l_distribution_surveyindices_linear(alpha = NULL, beta = 1)

g3l_distribution_sumofsquaredlogratios(epsilon = 10)

g3l_abundancedistribution(
        nll_name,
        obs_data,
        fleets = list(),
        stocks,
        function_f,
        transform_fs = list(),
        missing_val = 0,
        area_group = NULL,
        report = FALSE,
        nll_breakdown = FALSE,
        weight = substitute(
            g3_param(n, optimise = FALSE, value = 1),
            list(n = paste0(nll_name, "_weight"))),
        run_at = g3_action_order$likelihood)

g3l_catchdistribution(
        nll_name,
        obs_data,
        fleets = list(),
        stocks,
        function_f,
        transform_fs = list(),
        missing_val = 0,
        area_group = NULL,
        report = FALSE,
        nll_breakdown = FALSE,
        weight = substitute(
            g3_param(n, optimise = FALSE, value = 1),
            list(n = paste0(nll_name, "_weight"))),
        run_at = g3_action_order$likelihood)

g3_distribution_preview(
        obs_data,
        fleets = list(),
        stocks = list(),
        area_group = NULL)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>over</code></td>
<td>

<p>When comparing proportions of lengthgroups, specifies the dimensions that define the total.
For example the default "area" means the proprtion of the current lengthgroup to all individuals
in that area.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>rho_f,sigma_f</code></td>
<td>

<p>formula substituted into multivariate calcuations, see below.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>epsilon</code></td>
<td>

<p>Value to be used whenever the calculated probability is very unlikely. Default 10.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha</code></td>
<td>

<p>formula substituted into surveyindices calcuations to fix intercept of linear regression,
or NULL if not fixed. See below.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>beta</code></td>
<td>

<p>formula substituted into surveyindices calcuations to fix slope of linear regression,
or NULL if not fixed. See below.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nll_name</code></td>
<td>

<p>Character string, used to define the variable name for <var>obsstock</var> and <var>modelstock</var>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>obs_data</code></td>
<td>

<p>Data.frame of observation data, for example the results of
mfdb_sample_count.
</p>
<p>Should at least have a year column, and a length or weight column.
For more information, see "obs_data and data aggregation" below.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fleets</code></td>
<td>

<p>A list of <code>g3_stock</code> objects to collect catch data for.
If empty, will collect abundance data for <var>stocks</var> instead.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>stocks</code></td>
<td>

<p>A list of <code>g3_stock</code> objects to collect catch or abundance data for,
depending if <var>stocks</var> were provided.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>function_f</code></td>
<td>

<p>A formula to compare <var>obsstock__x</var> to <var>modelstock__x</var> and generate nll,
defined by one of the <var>g3l_distribution_</var>* functions.
</p>
<p>This will be adapted to compare either number (<var>modelstock__num</var>) or weight (<var>modelstock__wgt</var>)
depending on what columns <var>obs_data</var> has.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>transform_fs</code></td>
<td>

<p>A list of dimension name to formula to apply to model data before collating. See examples.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>missing_val</code></td>
<td>

<p>Where there are missing values in the incoming data, value to replace them with.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>area_group</code></td>
<td>

<p>mfdb_group or list mapping area names used in
<var>obs_data</var> to integer model areas, see "obs_data and data aggregation"
below.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>report</code></td>
<td>

<p>If TRUE, add model and observation arrays to the model report, called
<code>cdist_<var>nll_name</var>_model__num/wgt</code> and <code>cdist_<var>nll_name</var>_obs__num/wgt</code>
respectively
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nll_breakdown</code></td>
<td>

<p>Should the nll report be broken down by time? <code>TRUE</code> / <code>FALSE</code>
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weight</code></td>
<td>

<p>Weighting applied to this likelihood component. Default is a <code>g3_param</code>
that defaults to 1, allowing weights to be altered without recompiling.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>run_at</code></td>
<td>

<p>Integer order that actions will be run within model, see <code>g3_action_order</code>.
</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The actions will define the following variables in your model:
</p>

<dl>
<dt>
<var>obsstock</var>__num/wgt</dt>
<dd>
<p>A <code>g3_stock</code> instance that contains all observations in an array</p>
</dd>
<dt>
<var>modelstock</var>__num/wgt</dt>
<dd>
<p>A <code>g3_stock</code> instance that groups in an identical fashion to <var>obsstock</var>,
that will be filled with the model's predicted values</p>
</dd>
</dl>
<p>The model report will contain nll_cdist_<var>nll_name</var>__num and/or nll_cdist_<var>nll_name</var>__wgt, depending on
the columns in <var>obs_data</var> (a number column will compare by individuals, and produce a corresponding num report).
If <var>nll_breakdown</var> is <code>TRUE</code>, this will be an array with one entry per timestep.
</p>
<p><var>g3l_abundancedistribution</var> compares abundance of stocks, <var>g3l_catchdistribution</var> compares fleet catch.
Thus providing fleets is mandatory for <var>g3l_catchdistribution</var>, and an error for <var>g3l_abundancedistribution</var>.
</p>


<h4>obs_data and data aggregation</h4>

<p>The <var>obs_data</var> data.frame, as well as providing the observation data to
compare the model data against, controls the grouping of model data to
compare to the observation data, by inspecting the MFDB column attributes
produced by e.g. mfdb_sample_count.
</p>
<p>Metadata columns describe the observation datapoint in that row. The
columns should be from this list:
</p>

<dl>
<dt>year</dt>
<dd>
<p>Required.
Year for the data point. Gaps in years will result in no comparison for that year
</p>
</dd>
<dt>step</dt>
<dd>
<p>Optional.
If there is no step column, then the data is assumed to be yearly, and
the model data for all timesteps will be summed before comparing.
</p>
<p>Model timestep for the data point. Gaps in steps will result in no comparison for that year/step.
</p>
</dd>
<dt>length</dt>
<dd>
<p>Optional.
If missing all lengthgroups in the model will be summed to compare to
the data.
</p>
<p>The column can be a factor, as generated by <code>cut()</code>, e.g
<code>cut(raw_length, c(seq(0, 50, by = 10), Inf), right = FALSE)</code>
for an open-ended upper group.
</p>
<p>The column can be character strings also formatted as factors as above.
The column entries are assumed to be sorted in order and converted back
to a factor.
</p>
<p>If <code>open_ended = c('lower', 'upper')</code> was used when querying MFDB
for the data, then the bottom/top length groups will be modified to
start from zero or be infinite respectively.
</p>
<p>Any missing lengthgroups (when there is otherwise data for that
year/step) will be compared to zero.
</p>
</dd>
<dt>age</dt>
<dd>
<p>Optional.
If missing all age-groups (if any) in the model will be summed to compare to
the data.
</p>
<p>Model ages will be grouped by the same groupings as MFDB used, thus if
the data was formed with a query <code>age = mfdb_group(young = 1:3,
        old = 4:5)</code>, then the model data will similarly have 2 groups in it.
</p>
<p>Any missing ages (when there is otherwise data for that
year/step) will be compared to zero.
</p>
</dd>
<dt>stock</dt>
<dd>
<p>Optional.
If this and stock_re are missing all stocks in <var>stocks</var> will be
summed to compare to the data.
</p>
<p>The values in the stocks column should match the names of the stocks
given in the <var>stocks</var> parameter. This column can be factor or
character.
</p>
<p>Any missing stocks (when there is otherwise data for that
year/step) will be compared to zero.
</p>
</dd>
<dt>stock_re</dt>
<dd>
<p>Optional.
If this and stock are missing all stocks in <var>stocks</var> will be summed
to compare to the data.
</p>
<p>The values in the stocks column will be used as regular expressions to
match the names of the stocks given in the <var>stocks</var> parameter. For
example, '_mat_' will match both 'ghd_mat_f' and 'ghd_mat_m' and will
be compared against the sum of the 2 stocks.
</p>
<p>Any missing stocks (when there is otherwise data for that
year/step) will be compared to zero.
</p>
</dd>
<dt>fleet</dt>
<dd>
<p>Optional.
If this and fleet_re are missing all fleets in <var>fleets</var> will be
summed to compare to the data.
</p>
<p>The values in the fleets column should match the names of the fleets
given in the <var>fleets</var> parameter. This column can be factor or
character.
</p>
<p>Any missing fleets (when there is otherwise data for that
year/step) will be compared to zero.
</p>
</dd>
<dt>fleet_re</dt>
<dd>
<p>Optional.
If this and fleet are missing all fleets in <var>fleets</var> will be summed
to compare to the data.
</p>
<p>The values in the fleets column will be used as regular expressions to
match the names of the fleets given in the <var>fleets</var> parameter. For
example, '_trawl_' will match both 'fleet_trawl_is' and 'fleet_trawl_no' and will
be compared against the sum of the 2 fleets.
</p>
<p>Any missing fleets (when there is otherwise data for that
year/step) will be compared to zero.
</p>
</dd>
<dt>area</dt>
<dd>
<p>Optional.
If missing all areas in the model will be summed to compare to
the data.
</p>
<p>Unlike other columns, the MFDB grouping here is ignored (the areas it
is grouping over aren't integer model areas). Instead, the
<var>area_group</var> parameter should describe how to map from the area
names used in the table to integer model areas.
</p>
<p>For example, if <code>area_group = list(north=1:2, south=3:5)</code>, then
the area column of <var>obs_data</var> should contain either "north" or
"south", and corresponding model data will be summed from integer model
areas 1,2 and 3,4,5 respectively.
</p>
<p>If <var>area_group</var> is not supplied, then we assume that <var>obs_data</var>
area column will contain model area integers.
</p>
<p>Any missing areas (when there is otherwise data for that
year/step) will be compared to zero.
</p>
</dd>
</dl>
<p>Data columns contain the observation data to compare. There should be at
least one of:
</p>

<dl>
<dt>number</dt>
<dd>
<p>If a number column appears in <var>obs_data</var>, then the stock abundance
by individuals will be aggregated and compared to the <var>obs_data</var>
number column.
</p>
</dd>
<dt>weight</dt>
<dd>
<p>If a weight column appears in <var>obs_data</var>, then the total biomass of
the stock will be aggregated and compared to the <var>obs_data</var> number
column.
</p>
</dd>
</dl>
<p>You can use <code>g3_distribution_preview</code> to see how your observation data
will be converted into an array.
</p>



<h3>Value</h3>



<h4>g3l_distribution_sumofsquares</h4>

<p>Returns a formula for use as <var>function_f</var>:
</p>
<p style="text-align: center;"><code class="reqn"> \sum_{\it lengths} \Big( \frac{N_{tral}}{N_{tr}} - \frac{\nu_{tral}}{\nu_{tr}}  \Big) ^2 </code>
</p>


<dl>
<dt><code class="reqn">N_{tral}</code></dt>
<dd>
<p>Observation sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\nu_{tral}</code></dt>
<dd>
<p>Model sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">N_{tr}</code></dt>
<dd>
<p>Total observation sample size for current time/area (or dimensions set in <var>over</var>)</p>
</dd>
<dt><code class="reqn">\nu_{tr}</code></dt>
<dd>
<p>Total model sample size for current time/area (or dimensions set in <var>over</var>)</p>
</dd>
</dl>
<h4>g3l_distribution_multinomial</h4>

<p>Returns a formula for use as <var>function_f</var>:
</p>
<p style="text-align: center;"><code class="reqn">
      2 (
        \sum_{\it lengths} \log N_{tral}! -
        \log (\sum_{\it lengths} N_{tral})! -
        \sum_{\it lengths} ( N_{tral} \log min(\frac{\nu_{tral}}{\sum_{\it lengths} \nu_{tral}}, \frac{1}{l \epsilon}) )
      )
    </code>
</p>


<dl>
<dt><code class="reqn">N_{tral}</code></dt>
<dd>
<p>Observation sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\nu_{tral}</code></dt>
<dd>
<p>Model sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">l</code></dt>
<dd>
<p>Number of lengthgroups in sample</p>
</dd>
<dt><code class="reqn">\epsilon</code></dt>
<dd>
<p><var>epsilon</var> parameter</p>
</dd>
</dl>
<h4>g3l_distribution_multivariate</h4>

<p>Returns a formula for use as <var>function_f</var>, which calls TMB's <code>SCALE(AR1(rho), sigma)(x)</code>, where
<var>rho</var> and <var>sigma</var> are parameters, and <code>x</code> is defined as:
</p>
<p style="text-align: center;"><code class="reqn"> \frac{N_{tral}}{N_{tr}} - \frac{\nu_{tral}}{\nu_{tr}} </code>
</p>


<dl>
<dt><code class="reqn">N_{tral}</code></dt>
<dd>
<p>Observation sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\nu_{tral}</code></dt>
<dd>
<p>Model sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">N_{tr}</code></dt>
<dd>
<p>Total observation sample size for current time/area (or dimensions set in <var>over</var>)</p>
</dd>
<dt><code class="reqn">\nu_{tr}</code></dt>
<dd>
<p>Total model sample size for current time/area (or dimensions set in <var>over</var>)</p>
</dd>
</dl>
<p>For more information, see <a href="http://kaskr.github.io/adcomp/_book/Densities.html#autoregressive-processes">Autoregressive processes</a>
in the TMB book.
</p>



<h4>g3l_distribution_surveyindices_log</h4>

<p>Returns a formula for use as <var>function_f</var>:
</p>
<p style="text-align: center;"><code class="reqn">
      \sum_{\it time} (\alpha + \beta \log N_{tral} - \log \nu_{tral})^2
    </code>
</p>


<dl>
<dt><code class="reqn">N_{tral}</code></dt>
<dd>
<p>Observation sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\nu_{tral}</code></dt>
<dd>
<p>Model sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\alpha</code></dt>
<dd>
<p><var>alpha</var> parameter</p>
</dd>
<dt><code class="reqn">\beta</code></dt>
<dd>
<p><var>beta</var> parameter</p>
</dd>
</dl>
<p>If <var>alpha</var> or <var>beta</var> is not provided, then linear regression is
performed on <code class="reqn">N</code>, <code class="reqn">\nu</code> over time for each area/age/length combination.
The used values will be stored in a <code>cdist_<var>nll_name</var>_model__param</code> array and
reported after model run, whether calculated or hard-coded.
</p>



<h4>g3l_distribution_surveyindices_linear</h4>

<p>Returns a formula for use as <var>function_f</var>:
</p>
<p style="text-align: center;"><code class="reqn">
      \sum_{\it lengths} (\alpha + \beta N_{tral} - \nu_{tral})^2
    </code>
</p>


<dl>
<dt><code class="reqn">N_{tral}</code></dt>
<dd>
<p>Observation sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\nu_{tral}</code></dt>
<dd>
<p>Model sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\alpha</code></dt>
<dd>
<p><var>alpha</var> parameter</p>
</dd>
<dt><code class="reqn">\beta</code></dt>
<dd>
<p><var>beta</var> parameter</p>
</dd>
</dl>
<p>If <var>alpha</var> or <var>beta</var> is not provided, then linear regression is
performed on <code class="reqn">N</code>, <code class="reqn">\nu</code> over time for each area/age/length combination.
The used values will be stored in a <code>cdist_<var>nll_name</var>_model__param</code> array and
reported after model run, whether calculated or hard-coded.
</p>



<h4>g3l_distribution_sumofsquaredlogratios</h4>

<p>The equivalent of gadget2's <code>catchinkilos</code>.
</p>
<p>Returns a formula for use as <var>function_f</var>:
</p>
<p style="text-align: center;"><code class="reqn">
      \sum_{\it lengths} (log(N_{tral} + \epsilon) - log(\nu_{tral} + \epsilon))^2
    </code>
</p>


<dl>
<dt><code class="reqn">N_{tral}</code></dt>
<dd>
<p>Observation sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\nu_{tral}</code></dt>
<dd>
<p>Model sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\epsilon</code></dt>
<dd>
<p><var>epsilon</var> parameter</p>
</dd>
</dl>
<h4>g3l_abundancedistribution</h4>

<p>An action (i.e. list of formula objects) that will...</p>

<ol>
<li>
<p>For all <var>stocks</var>, collect catch data into <var>modelstock</var>__num or <var>modelstock</var>__wgt, depending on the columns provided in <var>obs_data</var>
</p>
</li>
<li>
<p>Compare <var>modelstock</var>__num/wgt with <var>obsstock</var>__num/wgt, using <var>function_f</var>
</p>
</li>
</ol>
<p>The output of <var>function_f</var> is summed over all stock dimensions (age/area) and time and added to <code>nll</code>.
</p>



<h4>g3l_catchdistribution</h4>

<p>An action (i.e. list of formula objects) that will...</p>

<ol>
<li>
<p>For all <var>fleets</var> and <var>stocks</var> combinations, collect catch data into <var>modelstock</var>__num or <var>modelstock</var>__wgt, depending on the columns provided in <var>obs_data</var>
</p>
</li>
<li>
<p>Compare <var>modelstock</var>__num/wgt with <var>obsstock</var>__num/wgt, using <var>function_f</var>
</p>
</li>
</ol>
<p>The output of <var>function_f</var> is summed over all stock dimensions (age/area) and time and added to <code>nll</code>.
</p>



<h4>g3_distribution_preview</h4>

<p>The input <var>obs_data</var> formatted as an array, applying the same rules that <code>g3l_*distribution</code> will.
</p>



<h3>See Also</h3>

<p><a href="https://gadget-framework.github.io/gadget2/userguide/chap-like.html">https://gadget-framework.github.io/gadget2/userguide/chap-like.html</a>,
<code>g3_stock</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">
ling_imm &lt;- g3_stock('ling_imm', seq(20, 156, 4)) %&gt;% g3s_age(3, 10)
ling_mat &lt;- g3_stock('ling_mat', seq(20, 156, 4)) %&gt;% g3s_age(5, 15)
lln &lt;- g3_fleet('lln')

# Invent a ldist.lln table for our tests
ldist.lln.raw &lt;- data.frame(
    year = c(1999, 2000),
    age = sample(5:9, 100, replace = TRUE),
    length = sample(10:70, 100, replace = TRUE),
    number = 1,
    stringsAsFactors = FALSE)

# Group length into 10-long bins
# NB: The last 2 bins will be empty, but gadget3 will use the factor levels, include them as zero
# NB: Generally one would use mfdb::mfdb_sample_count() source and group data for you
ldist.lln.raw |&gt; dplyr::group_by(
  year = year, age = age,
  length = cut(length, breaks = seq(10, 100, by = 10), right = FALSE)
) |&gt; dplyr::summarise(number = sum(number), .groups = 'keep') -&gt; ldist.lln

# Turn age into a factor, indicating all ages we should be interested in
ldist.lln$age &lt;- factor(ldist.lln$age, levels = 5:15)

# We can see the results of this being turned into an array:
g3_distribution_preview(ldist.lln)

likelihood_actions &lt;- list(
  g3l_catchdistribution(
    'ldist_lln',
    ldist.lln,
    fleets = list(lln),
    stocks = list(ling_imm, ling_mat),
    g3l_distribution_sumofsquares()))

# Make an (incomplete) model using the action, extract the observation array
fn &lt;- suppressWarnings(g3_to_r(likelihood_actions))
environment(fn)$cdist_sumofsquares_ldist_lln_obs__num

# Apply age-reading error matrix to model data
more_likelihood_actions &lt;- list(
  g3l_catchdistribution(
    'ldist_lln_readerror',
    ldist.lln,
    fleets = list(lln),
    stocks = list(ling_imm, ling_mat),
    transform_fs = list(age = g3_formula(
      g3_param_array('reader1matrix', value = diag(5))[g3_idx(preage), g3_idx(age)]
      )),
    g3l_distribution_sumofsquares()))

# Apply per-stock age-reading error matrix to model data
more_likelihood_actions &lt;- list(
  g3l_catchdistribution(
    'ldist_lln_readerror',
    ldist.lln,
    fleets = list(lln),
    stocks = list(ling_imm, ling_mat),
    transform_fs = list(age = g3_formula(stock_switch(stock,
      ling_imm = g3_param_array('imm_readermatrix',
          value = diag(ling_imm__maxage - ling_imm__minage + 1)
          )[ling_imm__preage_idx, ling_imm__age_idx],
      ling_mat = g3_param_array('mat_readermatrix',
          value = diag(ling_mat__maxage - ling_mat__minage + 1)
          )[ling_mat__preage_idx, ling_mat__age_idx],
      unused = 0))),
    g3l_distribution_sumofsquares()))
</code></pre>


</div>